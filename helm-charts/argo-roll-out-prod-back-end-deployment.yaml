---
# Source: argo-rollouts-back-end/templates/argoRollouts.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: backend
  namespace: argo-cd-rollout-front-end-prod-namespace
spec:
  replicas: 10
  strategy:
    canary:
      steps:
        - setWeight: 20
        - pause: { duration: 20m }
        - analysis: # TODO -> ğŸ‘‰â€œBefore moving to the next canary step, run a health check based on metrics.â€ : Most production-safe approach âœ…
            templates:
              - templateName: error_rate
              - templateName: latency
              - templateName: pod-restarts

        - setWeight: 40
        - pause: { duration: 15m }
        - analysis:
            templates:
              - templateName: cpu-usage
              - templateName: memory-usage
              - templateName: dependency-health

        - setWeight: 60
        - pause: { duration: 20m }
        - analysis: # TODO _> ğŸ‘‰ â€œBefore moving to the next canary step, check application latency using a predefined analysis template.â€
            templates:
              - templateName: latency
              - templateName: success-rate

        - setWeight: 80
        - pause: { duration: 10m }

        - setWeight: 100
  selector:
    matchLabels:
      app: app-label
      env: prod
  template:
    metadata:
      labels:
            app: app-label
            env: prod
    spec:
      containers:
        - name: springbootcontainer
          image: "srinu641/spring-application-k8s:v3.0"
          ports:
            - containerPort: 1199
